<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Edit User</title>
    <!-- 新 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="./css/bootstrap.min.css">

    <!-- 可选的Bootstrap主题文件（一般不用引入） -->
    <link rel="stylesheet" href="./css/bootstrap-theme.min.css">

    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <script src="./js/jQuery.js"></script>

    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="./js/bootstrap.min.js"></script>
</head>
<body width="80%">
<div class="form-horizontal" role="form" style="width:70%;margin-left: auto;margin-right: auto;">
    <div class="form-group">
        <label for="id" class="col-sm-2 control-label">id</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="id" placeholder="id" disabled>
        </div>
    </div>

    <div class="form-group">
        <label for="group" class="col-sm-2 control-label">组</label>
        <div class="col-sm-10">
            <select class="form-control" id="group">

            </select>
        </div>
    </div>

    <div class="form-group">
        <label for="tenant" class="col-sm-2 control-label">tenant</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="tenant" placeholder="tenant">
        </div>
    </div>
    <div class="form-group">
        <label for="username" class="col-sm-2 control-label">username</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="username" placeholder="username">
        </div>
    </div>
    <div class="form-group">
        <label for="sex" class="col-sm-2 control-label">sex</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="sex" placeholder="sex">
        </div>
    </div>
    <div class="form-group">
        <label for="firstname" class="col-sm-2 control-label">firstname</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="firstname" placeholder="firstname">
        </div>
    </div>
    <div class="form-group">
        <label for="birthdate" class="col-sm-2 control-label">birthdata</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="birthdate" placeholder="birthdate">
        </div>
    </div>
    <div class="form-group">
        <label for="lastname" class="col-sm-2 control-label">lastname</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="lastname" placeholder="lastname">
        </div>
    </div>
    <div class="form-group">
        <label for="status" class="col-sm-2 control-label">status</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="status" placeholder="status">
        </div>
    </div>
    <div class="form-group">
        <label for="activation_status" class="col-sm-2 control-label">activation_status</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="activation_status" placeholder="activation_status">
        </div>
    </div>
    <div class="form-group">
        <label for="email" class="col-sm-2 control-label">email</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="email" placeholder="email">
        </div>
    </div>
    <div class="form-group">
        <label for="workfromdate" class="col-sm-2 control-label">workfromdate</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="workfromdate" placeholder="workfromdate">
        </div>
    </div>
    <div class="form-group">
        <label for="terminateddate" class="col-sm-2 control-label">terminateddate</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="terminateddate" placeholder="terminateddate">
        </div>
    </div>
    <div class="form-group">
        <label for="title" class="col-sm-2 control-label">title</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="title" placeholder="title">
        </div>
    </div>
    <div class="form-group">
        <label for="department" class="col-sm-2 control-label">department</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="department" placeholder="department">
        </div>
    </div>
    <div class="form-group">
        <label for="culture" class="col-sm-2 control-label">culture</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="culture" placeholder="culture">
        </div>
    </div>
    <div class="form-group">
        <label for="contacts" class="col-sm-2 control-label">contacts</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="contacts" placeholder="contacts">
        </div>
    </div>
    <div class="form-group">
        <label for="phone" class="col-sm-2 control-label">phone</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="phone" placeholder="phone">
        </div>
    </div>
    <div class="form-group">
        <label for="phone_activation" class="col-sm-2 control-label">phone_activation</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="phone_activation" placeholder="phone_activation">
        </div>
    </div>
    <div class="form-group">
        <label for="location" class="col-sm-2 control-label">location</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="location" placeholder="location">
        </div>
    </div>
    <div class="form-group">
        <label for="notes" class="col-sm-2 control-label">notes</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="notes" placeholder="notes">
        </div>
    </div>
    <div class="form-group">
        <label for="removed" class="col-sm-2 control-label">removed</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="removed" placeholder="removed">
        </div>
    </div>
    <div class="form-group">
        <label for="permission" class="col-sm-2 control-label">模块权限</label>
        <div class="col-sm-10" id="permission">

        </div>

    </div>
    <div class="form-group">
        <label for="api" class="col-sm-2 control-label">api权限</label>
        <div class="col-sm-10" id="api">

        </div>

    </div>
    <div class="form-group">
        <div class="col-sm-offset-2 col-sm-10">
            <button type="submit" class="btn btn-default" id="btn-submit">Update</button>
        </div>
    </div>
</div>


<script>

    function getParameters(){
        var url = location.href;
        var param=url.split('?');
        var kw = param[1].split('=');
        return kw[1];
    }

    function getUserListbyId()
    {
        var id= getParameters();
        var postData = {
            id : id
        };

        $.ajax({
            type: "post",
            url: "/api/manage/GetUserById",
            data:  postData,
            success:function(data){
                if(data&&data.Result)
                {
                    var options = data.Data;
                    $("#id").val(options[0].id)
                    $("#tenant").val(options[0].tenant);
                    $("#username").val(options[0].username);
                    $("#firstname").val(options[0].firstname);
                    $("#lastname").val(options[0].lastname);
                    $("#sex").val(options[0].sex);
                    $("#bithdate").val(options[0].bithdate);
                    $("#status").val(options[0].status);
                    $("#activation_status").val(options[0].activation_status);
                    $("#email").val(options[0].email);
                    $("#workfromdate").val(options[0].workfromdate);
                    $("#terminateddate").val(options[0].terminateddate);
                    $("#title").val(options[0].title);
                    $("#department").val(options[0].department);
                    $("#culture").val(options[0].culture);
                    $("#contacts").val(options[0].contacts);
                    $("#phone").val(options[0].phone);
                    $("#phone_activation").val(options[0].phone_activation);
                    $("#location").val(options[0].location);
                    $("#notes").val(options[0].notes);
                    $("#removed").val(options[0].removed);
                    $("#groupid").val(options[0].groupid);

                    var permission = options[0].permission;
                    for(var item in permission) {
                        $("[name = pcheck]:checkbox").each(function () {
                            if ($(this).val() == permission[item].id) {
                                $(this).attr("checked", true);
                            }
                        });
                    }


                    var api = options[0].api;
                    for(var item in api) {
                        $("[name = apicheck]:checkbox").each(function () {
                            if ($(this).val() == api[item].id) {
                                $(this).attr("checked", true);
                            }
                        });
                    }
                }
            }
        });
    }

    $(function () {

        $.ajax({
            type: "post",
            url: "/api/manage/GetGroupList",
            data:{},
            success:function(data){
                if(data&&data.Result)
                {
                    var options = data.Data;

                    for(var item in options)
                    {
                        var opValue = options[item].id,
                                opText  = options[item].name;
                        $("#group").append("<option value='"+opValue+"'>"+opText+"</option>");  //添加一项option

                    }
                }
            }
        });

        $.ajax({
            type: "post",
            url: "/api/manage/GetPermission",
            data: {},
            success:function(data){
                if(data&&data.Result)
                {

                    var options = data.Data.model;
                    for(var item in options){
                        if(options[item].parentid == '0'){
                            var subOptions = $.grep(options,function(n,i){
                                return n.parentid == options[item].id;
                            });
                            var label =$("<div></div>");
                            for(var sumItem in subOptions){
                                label.append('<div class="checkbox"><label><input type="checkbox" name="pcheck" value ='+subOptions[sumItem].id+' data-parentid='+subOptions[sumItem].parentid+'>'+subOptions[sumItem].name+'</label></div>');
                            }

                            $("#permission").append('<div class="checkbox"><label><input type="checkbox" name="pcheck" value ='+options[item].id+'>'+options[item].name +label.html()+'</label></div>');
                        }
                    }
                    options = data.Data.api;
                    for(var item in options){

                        $("#api").append('<div class="checkbox"><label><input type="checkbox" name="apicheck" value ='+options[item].id+'>'+options[item].notes+'</label></div>');
                    }

                }
                getUserListbyId();
            }
        });

        $("#btn-submit").click(function(){
            var user = {};
            user.id =$("#id").val();
            user.tenant = $("#tenant").val();
            user.username = $("#username").val();
            user.firstname = $("#firstname").val();
            user.lastname = $("#lastname").val();
            user.sex = $("#sex").val();
            user.bithdate = $("#bithdate").val();
            user.status = $("#status").val();
            user.activation_status = $("#activation_status").val();
            user.email = $("#email").val();
            user.workfromdate = $("#workfromdate").val();
            user.terminateddate = $("#terminateddate").val();
            user.title = $("#title").val();
            user.department = $("#department").val();
            user.culture = $("#culture").val();
            user.contacts = $("#contacts").val();
            user.phone = $("#phone").val();
            user.phone_activation = $("#phone_activation").val();
            user.location = $("#location").val();
            user.notes = $("#notes").val();

            user.removed = $("#removed").val();
            user.groupid=$("#group").val();

            var result = new Array();
            $("[name = pcheck]:checkbox").each(function () {
                if ($(this).is(":checked")) {
                    result.push($(this).attr("value"));
                }
            });

            var apiResult = new Array();
            $("[name = apicheck]:checkbox").each(function () {
                if ($(this).is(":checked")) {
                    apiResult.push($(this).attr("value"));
                }
            });

            user.permission=result.join("#;");
            user.api=apiResult.join("#;");

            $.ajax({
                type: "put",
                url: "/api/manage/SaveUser",
                data: user,
                success:function(data){
                    if(data&&data.Result)
                    {
                        alert(JSON.stringify(data.Data));
                    }
                }
            });
        });
    });
</script>
</body>
</html>