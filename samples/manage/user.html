<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>User</title>
    <!-- 新 Bootstrap 核心 CSS 文件 -->
    <link rel="stylesheet" href="./css/bootstrap.min.css">

    <!-- 可选的Bootstrap主题文件（一般不用引入） -->
    <link rel="stylesheet" href="./css/bootstrap-theme.min.css">

    <!-- jQuery文件。务必在bootstrap.min.js 之前引入 -->
    <script src="./js/jQuery.js"></script>

    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <script src="./js/bootstrap.min.js"></script>
</head>
<body width="80%">
<div class="form-horizontal" role="form" style="width:70%;margin-left: auto;margin-right: auto;">
    <div class="form-group">
        <label for="group" class="col-sm-2 control-label">组</label>
        <div class="col-sm-10">
            <select class="form-control" id="group">

            </select>
        </div>
    </div>

    <div class="form-group">
        <label for="tenant" class="col-sm-2 control-label">tenant</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="tenant" placeholder="tenant">
        </div>
    </div>
    <div class="form-group">
        <label for="username" class="col-sm-2 control-label">username</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="username" placeholder="username">
        </div>
    </div>
    <div class="form-group">
        <label for="sex" class="col-sm-2 control-label">sex</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="sex" placeholder="sex">
        </div>
    </div>
    <div class="form-group">
        <label for="firstname" class="col-sm-2 control-label">firstname</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="firstname" placeholder="firstname">
        </div>
    </div>
    <div class="form-group">
        <label for="birthdate" class="col-sm-2 control-label">birthdata</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="birthdate" placeholder="birthdate">
        </div>
    </div>
    <div class="form-group">
        <label for="lastname" class="col-sm-2 control-label">lastname</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="lastname" placeholder="lastname">
        </div>
    </div>
    <div class="form-group">
        <label for="status" class="col-sm-2 control-label">status</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="status" placeholder="status">
        </div>
    </div>
    <div class="form-group">
        <label for="activation_status" class="col-sm-2 control-label">activation_status</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="activation_status" placeholder="activation_status">
        </div>
    </div>
    <div class="form-group">
        <label for="email" class="col-sm-2 control-label">email</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="email" placeholder="email">
        </div>
    </div>
    <div class="form-group">
        <label for="workfromdate" class="col-sm-2 control-label">workfromdate</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="workfromdate" placeholder="workfromdate">
        </div>
    </div>
    <div class="form-group">
        <label for="terminateddate" class="col-sm-2 control-label">terminateddate</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="terminateddate" placeholder="terminateddate">
        </div>
    </div>
    <div class="form-group">
        <label for="title" class="col-sm-2 control-label">title</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="title" placeholder="title">
        </div>
    </div>
    <div class="form-group">
        <label for="department" class="col-sm-2 control-label">department</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="department" placeholder="department">
        </div>
    </div>
    <div class="form-group">
        <label for="culture" class="col-sm-2 control-label">culture</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="culture" placeholder="culture">
        </div>
    </div>
    <div class="form-group">
        <label for="contacts" class="col-sm-2 control-label">contacts</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="contacts" placeholder="contacts">
        </div>
    </div>
    <div class="form-group">
        <label for="phone" class="col-sm-2 control-label">phone</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="phone" placeholder="phone">
        </div>
    </div>
    <div class="form-group">
        <label for="phone_activation" class="col-sm-2 control-label">phone_activation</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="phone_activation" placeholder="phone_activation">
        </div>
    </div>
    <div class="form-group">
        <label for="location" class="col-sm-2 control-label">location</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="location" placeholder="location">
        </div>
    </div>
    <div class="form-group">
        <label for="notes" class="col-sm-2 control-label">notes</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="notes" placeholder="notes">
        </div>
    </div>
    <div class="form-group">
        <label for="removed" class="col-sm-2 control-label">removed</label>
        <div class="col-sm-10">
            <input type="text" class="form-control" id="removed" placeholder="removed">
        </div>
    </div>
    <div class="form-group">
        <label for="permission" class="col-sm-2 control-label">模块权限</label>
        <div class="col-sm-10" id="permission">

        </div>

    </div>
    <div class="form-group">
        <label for="api" class="col-sm-2 control-label">api权限</label>
        <div class="col-sm-10" id="api">

        </div>

    </div>
    <div class="form-group">
        <div class="col-sm-offset-2 col-sm-10">
            <button type="submit" class="btn btn-default" id="btn-submit">Save</button>
        </div>
    </div>
</div>

<div style="width:70%;margin-left: auto;margin-right: auto;">
    <div>
        user name:  <input type="text" class="form-control" id="gName" placeholder="user name">
        <button type="submit" class="btn btn-default" id="btn-search">Search</button>
    </div>
    <table class="table table-hover">
        <thead>
        <th>id</th>
        <th>tenant</th>
        <th>name</th>
        <th>last_modify</th>
        <th>removed</th>
        <th>create_on</th>

        <th></th>
        </thead>
        <tbody id="UserList">

        </tbody>
    </table>
</div>
<script>
    function getUserList()
    {
        var postData = {
            orderby: {
                last_modified : "desc"
            },
            query: {

            },
            pagination: {
                topn: "12",
                pagesize: "2",
                pageindex: 0
            }
        };

        $.ajax({
            type: "post",
            url: "/api/manage/GetUserList",
            data:  {params: postData},
            success:function(data){
                if(data&&data.Result)
                {
                    var options = data.Data;

                    for(var item in options)
                    {
                        $("#UserList").append("<tr><td>"+options[item].id
                                +"</td><td>"+options[item].tenant
                                +"</td><td>"+options[item].username
                                +"</td><td>"+options[item].last_modified
                                +"</td><td>"+options[item].removed
                                +"</td><td>"+options[item].create_on

                                +"</td><td> <a href='javascript:void(0)' name='delete' bind-id="+options[item].id
                                +">Delete</a> |  <a href='edituser.html?id="+options[item].id+"'>Edit</a> |  <a href='password.html?id="+options[item].id+"'>resetpw</a></td></tr>");
                    }
                }
            }
        });
    }

    function getUserListbyName(username)
    {
        var postData = {
            orderby: {
                last_modified : "desc"
            },
            query: {
                username : username
            },
            pagination: {
                topn: "12",
                pagesize: "2",
                pageindex: 0
            }
        };

        $.ajax({
            type: "post",
            url: "/api/manage/GetModelByCondition",
            data:  {params: postData},
            success:function(data){
                if(data&&data.Result)
                {
                    var options = data.Data;

                    for(var item in options)
                    {
                        $("#UserList").append("<tr><td>"+options[item].id
                                +"</td><td>"+options[item].tenant
                                +"</td><td>"+options[item].username
                                +"</td><td>"+options[item].last_modified
                                +"</td><td>"+options[item].removed
                                +"</td><td>"+options[item].create_on

                                +"</td><td> <a href='javascript:void(0)' name='delete' bind-id="+options[item].id
                                +">Delete</a> |  <a href='edituser.html?name="+options[item].name+"'>Edit</a></td></tr>");
                    }
                }
            }
        });
    }

    $(function () {

        $.ajax({
            type: "post",
            url: "/api/manage/GetGroupList",
            data:{},
            success:function(data){
                if(data&&data.Result)
                {
                    var options = data.Data;

                    for(var item in options)
                    {
                        var opValue = options[item].id,
                                opText  = options[item].name;
                        $("#group").append("<option value='"+opValue+"'>"+opText+"</option>");  //添加一项option

                    }
                }
            }
        });

        getUserList();


        //get model
        $.ajax({
            type: "post",
            url: "/api/manage/GetPermission",
            data: {},
            success:function(data){
                if(data&&data.Result)
                {
                    var options = data.Data.model;
                    for(var item in options){
                        if(options[item].parentid == '0'){
                            var subOptions = $.grep(options,function(n,i){
                                return n.parentid == options[item].id;
                            });
                            var label =$("<div></div>");
                            for(var sumItem in subOptions){
                                label.append('<div class="checkbox"><label><input type="checkbox" name="pcheck" value ='+subOptions[sumItem].id+' data-parentid='+subOptions[sumItem].parentid+'>'+subOptions[sumItem].name+'</label></div>');
                            }

                            $("#permission").append('<div class="checkbox"><label><input type="checkbox" name="pcheck" value ='+options[item].id+'>'+options[item].name +label.html()+'</label></div>');
                        }
                    }

                    options = data.Data.api;
                    for(var item in options){

                        $("#api").append('<div class="checkbox"><label><input type="checkbox" name="apicheck" value ='+options[item].id+'>'+options[item].notes+'</label></div>');
                    }

                }
            }
        });

        $("#btn-search").click(function(){
            $("#UserList").empty();
            getUserListbyName($("#gName").val());
        });

        $("#UserList").delegate("a","click",function(e){
            if(e.target.name == "delete"){
                $.ajax({
                    type: "delete",
                    url: "/api/manage/SaveUser",
                    data: {id:$(e.target).attr("bind-id")},
                    success:function(data){
                        if(data&&data.Result)
                        {
                            alert(JSON.stringify(data.Data));
                        }
                    }
                });
            }
        });

        $("#btn-submit").click(function(){
            var user = {};
            user.tenant = $("#tenant").val();
            user.username = $("#username").val();
            user.firstname = $("#firstname").val();
            user.lastname = $("#lastname").val();
            user.sex = $("#sex").val();
            user.bithdate = $("#bithdate").val();
            user.status = $("#status").val();
            user.activation_status = $("#activation_status").val();
            user.email = $("#email").val();
            user.workfromdate = $("#workfromdate").val();
            user.terminateddate = $("#terminateddate").val();
            user.title = $("#title").val();
            user.department = $("#department").val();
            user.culture = $("#culture").val();
            user.contacts = $("#contacts").val();
            user.phone = $("#phone").val();
            user.phone_activation = $("#phone_activation").val();
            user.location = $("#location").val();
            user.notes = $("#notes").val();

            user.removed = $("#removed").val();
            user.groupid=$("#group").val();

            var result = new Array();
            $("[name = pcheck]:checkbox").each(function () {
                if ($(this).is(":checked")) {
                    result.push($(this).attr("value"));
                }
            });

            var apiResult = new Array();
            $("[name = apicheck]:checkbox").each(function () {
                if ($(this).is(":checked")) {
                    apiResult.push($(this).attr("value"));
                }
            });

            user.permission=result.join("#;");
            user.api=apiResult.join("#;");

            $.ajax({
                type: "post",
                url: "/api/manage/SaveUser",
                data: user,
                success:function(data){
                    if(data&&data.Result)
                    {
                        alert(JSON.stringify(data.Data));
                    }
                    else{
                        alert("Error:"+data.Message);
                    }
                }
            });
        });
    });
</script>
</body>
</html>